# Code Quality and Security Checks
# Runs on pull requests and pushes to main/develop branches

name: Code Quality & Security

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'pom.xml'
      - '.github/workflows/code-quality.yml'
  workflow_dispatch:

jobs:
  code-quality:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better analysis

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Make Maven wrapper executable
      run: chmod +x ./mvnw

    - name: Run Maven compile
      run: ./mvnw clean compile -DskipTests

    - name: Run tests with coverage
      run: ./mvnw test
      continue-on-error: true

    - name: Generate test coverage report
      run: ./mvnw jacoco:report || echo "Jacoco plugin not configured, skipping coverage report"
      continue-on-error: true

    - name: Check code style
      run: |
        echo "ðŸ“‹ Checking code style..."
        # Check for common code style issues
        ./mvnw checkstyle:check || echo "Checkstyle plugin not configured"
      continue-on-error: true

    - name: Analyze with SpotBugs (if available)
      run: |
        echo "ðŸ› Running SpotBugs analysis..."
        ./mvnw spotbugs:check || echo "SpotBugs plugin not configured"
      continue-on-error: true

    - name: Upload test coverage to Codecov (optional)
      if: always()
      uses: codecov/codecov-action@v4
      with:
        files: ./target/site/jacoco/jacoco.xml
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}  # Optional
      continue-on-error: true

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          target/surefire-reports/**/*.xml
          target/site/jacoco/**
        retention-days: 7
        if-no-files-found: ignore

    - name: Generate quality report
      if: always()
      run: |
        echo "## Code Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Results" >> $GITHUB_STEP_SUMMARY
        if [ -d "target/surefire-reports" ]; then
          echo "- âœ… Test reports generated" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ Test reports not found" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Coverage Report" >> $GITHUB_STEP_SUMMARY
        if [ -d "target/site/jacoco" ]; then
          echo "- âœ… Coverage report generated" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š View coverage in artifacts" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ Coverage report not available" >> $GITHUB_STEP_SUMMARY
        fi

  security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Run OWASP Dependency Check
      uses: dependency-check/Dependency-Check_Action@main
      with:
        project: 'IRCTC Monolith'
        path: '.'
        format: 'ALL'
        args: >
          --enableRetired
          --failOnCVSS 7
      continue-on-error: true

    - name: Upload dependency check results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-report
        path: reports/**
        retention-days: 7
        if-no-files-found: ignore

    - name: Check for vulnerable dependencies with Maven
      run: |
        chmod +x ./mvnw
        echo "ðŸ” Checking for vulnerable dependencies..."
        ./mvnw org.owasp:dependency-check-maven:check || echo "Dependency check plugin not configured"
      continue-on-error: true

    - name: Generate security summary
      if: always()
      run: |
        echo "## Security Scan Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… OWASP Dependency Check completed" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“‹ View detailed reports in artifacts" >> $GITHUB_STEP_SUMMARY

