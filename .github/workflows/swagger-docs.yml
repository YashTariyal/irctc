# GitHub Actions workflow to generate and host Swagger documentation
# Publishes Swagger UI as GitHub Pages

name: Generate and Deploy Swagger Docs

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/**'
      - 'pom.xml'
  workflow_dispatch:
  release:
    types: [created]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-swagger:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build application
      run: |
        chmod +x ./mvnw
        ./mvnw clean compile -DskipTests

    - name: Extract OpenAPI/Swagger spec
      run: |
        mkdir -p swagger-docs
        
        # Get the server port from application.properties
        SERVER_PORT=$(grep "^server.port" src/main/resources/application.properties 2>/dev/null | cut -d'=' -f2 | tr -d ' ' || echo "8082")
        echo "Using server port: ${SERVER_PORT}"
        
        # Start application in background to extract Swagger JSON
        nohup ./mvnw spring-boot:run -Dspring-boot.run.arguments="--server.port=${SERVER_PORT}" > app.log 2>&1 &
        APP_PID=$!
        echo "Application started with PID: $APP_PID"
        
        # Wait for application to start
        echo "Waiting for application to start..."
        MAX_WAIT=120
        for i in $(seq 1 $MAX_WAIT); do
          if curl -f http://localhost:${SERVER_PORT}/actuator/health > /dev/null 2>&1; then
            echo "✅ Application started successfully!"
            break
          fi
          if [ $i -eq $MAX_WAIT ]; then
            echo "❌ Application failed to start within timeout"
            cat app.log || true
            exit 1
          fi
          echo "Waiting... ($i/$MAX_WAIT)"
          sleep 2
        done
        
        # Try multiple endpoints to get Swagger JSON
        echo "Downloading Swagger/OpenAPI specification..."
        if curl -f http://localhost:${SERVER_PORT}/v3/api-docs > swagger-docs/openapi.json 2>/dev/null; then
          echo "✅ Downloaded OpenAPI 3.0 spec"
        elif curl -f http://localhost:${SERVER_PORT}/api-docs > swagger-docs/openapi.json 2>/dev/null; then
          echo "✅ Downloaded API docs"
        elif curl -f http://localhost:${SERVER_PORT}/v2/api-docs > swagger-docs/swagger.json 2>/dev/null; then
          echo "✅ Downloaded Swagger 2.0 spec"
          # Convert to OpenAPI 3.0 format for Swagger UI
          mv swagger-docs/swagger.json swagger-docs/openapi.json
        else
          echo "⚠️ Could not download API docs, creating placeholder"
          echo '{"openapi":"3.0.0","info":{"title":"IRCTC API","version":"1.0.0"},"paths":{}}' > swagger-docs/openapi.json
        fi
        
        # Kill application
        echo "Stopping application..."
        kill $APP_PID 2>/dev/null || true
        sleep 2
        pkill -f "spring-boot:run" 2>/dev/null || true
        
        # Generate Swagger UI HTML
        cat > swagger-docs/index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IRCTC API Documentation</title>
  <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5/swagger-ui.css" />
  <style>
    html { box-sizing: border-box; overflow: -moz-scrollbars-vertical; overflow-y: scroll; }
    *, *:before, *:after { box-sizing: inherit; }
    body { margin:0; background: #fafafa; }
  </style>
</head>
<body>
  <div id="swagger-ui"></div>
  <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-bundle.js"></script>
  <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-standalone-preset.js"></script>
  <script>
    window.onload = function() {
      const ui = SwaggerUIBundle({
        url: "./openapi.json",
        dom_id: '#swagger-ui',
        deepLinking: true,
        presets: [
          SwaggerUIBundle.presets.apis,
          SwaggerUIStandalonePreset
        ],
        plugins: [
          SwaggerUIBundle.plugins.DownloadUrl
        ],
        layout: "StandaloneLayout"
      });
    };
  </script>
</body>
</html>
EOF

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: swagger-docs

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: generate-swagger
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

